<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–ö–ª—é—á–∏">
  <meta name="theme-color" content="#0a0a0f">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a0f' width='100' height='100' rx='20'/><text y='68' x='50' text-anchor='middle' font-size='55'>üîë</text></svg>">
  <link rel="manifest" href="manifest.json">
  <title>–ö–ª—é—á–∏ ‚Äî Illusionist OS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --gold: #f59e0b;
      --gold-light: #fbbf24;
      --bg: #0a0a0f;
      --bg2: rgba(26,26,46,0.95);
      --border: rgba(245,158,11,0.25);
      --text: #f8fafc;
      --text2: rgba(148,163,184,0.8);
      --green: #22c55e;
      --red: #ef4444;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    /* ===== TABS (mobile bottom bar) ===== */
    .tabs {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: rgba(10,10,15,0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      z-index: 100;
    }
    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 10px 4px 8px;
      color: var(--text2);
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
      border: none;
      background: none;
      -webkit-appearance: none;
    }
    .tab.active { color: var(--gold); }
    .tab-icon { font-size: 22px; }

    /* ===== PAGES ===== */
    .page {
      display: none;
      padding-top: calc(env(safe-area-inset-top, 0px) + 20px);
      padding-left: 16px;
      padding-right: 16px;
      padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      min-height: 100vh;
      min-height: 100dvh;
    }
    .page.active { display: block; }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 20px;
    }

    /* ===== CARDS ===== */
    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card-title {
      color: var(--gold);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 14px;
    }

    /* ===== FORM ===== */
    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block;
      color: var(--text2);
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--gold);
    }
    .form-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23f59e0b'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
    }

    /* ===== BUTTONS ===== */
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: transform 0.15s, opacity 0.15s;
      -webkit-appearance: none;
    }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.5; pointer-events: none; }
    .btn-primary {
      background: linear-gradient(135deg, var(--gold), var(--gold-light));
      color: #0a0a0f;
    }
    .btn-secondary {
      background: rgba(245,158,11,0.15);
      color: var(--gold);
      margin-top: 10px;
    }
    .btn-danger {
      background: rgba(239,68,68,0.15);
      color: var(--red);
    }
    .btn-small {
      width: auto;
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* ===== KEY DISPLAY ===== */
    .key-display {
      background: rgba(0,0,0,0.4);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      text-align: center;
      font-family: 'SF Mono', 'Courier New', monospace;
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 2px;
      word-break: break-all;
      min-height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== STATS ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }
    .stat-value {
      font-size: 26px;
      font-weight: 700;
      color: var(--gold);
    }
    .stat-label {
      font-size: 11px;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* ===== LICENSE LIST ===== */
    .search-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }
    .search-bar .form-input { flex: 1; padding: 12px 16px; }

    .filter-row {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .filter-row::-webkit-scrollbar { display: none; }
    .filter-chip {
      flex-shrink: 0;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      color: var(--text2);
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      font-family: inherit;
      -webkit-appearance: none;
      transition: all 0.2s;
    }
    .filter-chip.active {
      background: rgba(245,158,11,0.2);
      color: var(--gold);
      border-color: var(--gold);
    }

    .license-card {
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 10px;
      transition: background 0.2s;
    }
    .license-card.expired { border-color: rgba(239,68,68,0.3); }
    .license-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .license-app { font-weight: 600; font-size: 15px; }
    .license-buyer { color: var(--text2); font-size: 13px; margin-top: 2px; }
    .license-key {
      font-family: 'SF Mono', 'Courier New', monospace;
      font-size: 12px;
      color: var(--gold);
      background: rgba(0,0,0,0.3);
      padding: 6px 10px;
      border-radius: 6px;
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .license-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
      font-size: 12px;
      color: var(--text2);
    }
    .license-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-active { background: rgba(34,197,94,0.2); color: var(--green); }
    .badge-pending { background: rgba(234,179,8,0.2); color: #eab308; }
    .badge-expired { background: rgba(239,68,68,0.2); color: var(--red); }

    /* ===== APP STATS ===== */
    .app-stat-card {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
    }
    .app-stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .app-stat-name { font-weight: 600; color: var(--gold); font-size: 15px; }
    .app-stat-revenue { font-weight: 700; color: var(--green); font-size: 16px; }
    .app-stat-details {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text2);
    }

    /* ===== TOAST ===== */
    .toast {
      position: fixed;
      top: calc(var(--safe-top) + 16px);
      left: 16px;
      right: 16px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 14px;
      font-weight: 500;
      z-index: 200;
      transform: translateY(-120%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }
    .toast.show { transform: translateY(0); }

    /* ===== MODAL ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 150;
      align-items: flex-end;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 20px 20px 0 0;
      padding: 24px 20px calc(var(--safe-bottom) + 20px);
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 20px;
      text-align: center;
    }
    .modal-handle {
      width: 36px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      margin: 0 auto 16px;
    }

    /* ===== TIMER ===== */
    .countdown {
      font-family: 'SF Mono', 'Courier New', monospace;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* ===== CONNECTION STATUS ===== */
    .conn-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 16px;
    }
    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text2);
    }
    .conn-dot.ok { background: var(--green); }
    .conn-dot.err { background: var(--red); }

    select option { background: #1a1a2e; color: #fff; }

    /* ===== PIN LOCK SCREEN ===== */
    #lock-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: calc(env(safe-area-inset-top, 0px) + 40px) 20px calc(env(safe-area-inset-bottom, 0px) + 40px);
    }
    #lock-screen.hidden { display: none; }
    .lock-icon { font-size: 56px; margin-bottom: 20px; }
    .lock-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }
    .lock-subtitle {
      font-size: 14px;
      color: var(--text2);
      margin-bottom: 32px;
      text-align: center;
    }
    .pin-dots {
      display: flex;
      gap: 16px;
      margin-bottom: 36px;
    }
    .pin-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid var(--gold);
      transition: background 0.15s, transform 0.15s;
    }
    .pin-dot.filled {
      background: var(--gold);
      transform: scale(1.15);
    }
    .pin-dot.error {
      border-color: var(--red);
      background: var(--red);
      animation: pinShake 0.4s ease;
    }
    @keyframes pinShake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-6px); }
      40%, 80% { transform: translateX(6px); }
    }
    .pin-pad {
      display: grid;
      grid-template-columns: repeat(3, 72px);
      gap: 12px;
    }
    .pin-key {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      font-size: 28px;
      font-weight: 500;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
      -webkit-appearance: none;
      margin: 0;
      padding: 0;
    }
    .pin-key:active {
      background: rgba(245,158,11,0.3);
      transform: scale(0.92);
    }
    .pin-key.empty {
      background: transparent;
      border-color: transparent;
      cursor: default;
    }
    .pin-key.empty:active { transform: none; background: transparent; }
    .pin-key.backspace { font-size: 22px; }
    .lock-error {
      color: var(--red);
      font-size: 13px;
      margin-top: 16px;
      min-height: 20px;
      text-align: center;
    }
    .lock-setup-hint {
      color: var(--text2);
      font-size: 12px;
      margin-top: 24px;
      text-align: center;
    }
    #app-content.locked { display: none; }

    /* ===== DESKTOP ADAPTIVE (1024px+) ===== */
    @media (min-width: 1024px) {
      body {
        display: flex;
        justify-content: center;
      }

      #app-content {
        max-width: 1200px;
        width: 100%;
        min-height: 100vh;
        position: relative;
      }

      /* Sidebar tabs */
      .tabs {
        position: fixed;
        left: calc(50% - 600px);
        top: 0;
        bottom: 0;
        right: auto;
        width: 220px;
        flex-direction: column;
        border-top: none;
        border-right: 1px solid var(--border);
        padding: 32px 12px;
        padding-bottom: 0;
        gap: 4px;
      }
      .tab {
        flex: none;
        flex-direction: row;
        justify-content: flex-start;
        gap: 10px;
        padding: 14px 16px;
        border-radius: 12px;
        font-size: 14px;
      }
      .tab:hover { background: rgba(245,158,11,0.08); }
      .tab.active { background: rgba(245,158,11,0.15); }
      .tab-icon { font-size: 18px; }

      .page {
        margin-left: 220px;
        padding: 32px 40px 40px;
        max-width: 980px;
      }
      .page-title { font-size: 32px; margin-bottom: 24px; }
      .stats-grid { grid-template-columns: repeat(4, 1fr); gap: 14px; }
      .stat-value { font-size: 30px; }
      .card { max-width: 560px; padding: 24px; }
      .btn { max-width: 560px; }
      .search-bar { max-width: 480px; }
      .key-display { max-width: 560px; }
      .modal-overlay { align-items: center; }
      .modal { border-radius: 20px; max-width: 480px; }
      .toast { left: auto; right: 32px; max-width: 360px; }
    }

    /* Large desktop */
    @media (min-width: 1400px) {
      .tabs { left: calc(50% - 700px); width: 260px; }
      .page { margin-left: 260px; }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body>

<!-- ===== PIN LOCK SCREEN ===== -->
<div id="lock-screen">
  <div class="lock-icon">üîê</div>
  <div class="lock-title" id="lockTitle">–í–≤–µ–¥–∏—Ç–µ PIN</div>
  <div class="lock-subtitle" id="lockSubtitle">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—É –∫–ª—é—á–µ–π</div>
  <div class="pin-dots" id="pinDots">
    <div class="pin-dot"></div>
    <div class="pin-dot"></div>
    <div class="pin-dot"></div>
    <div class="pin-dot"></div>
  </div>
  <div class="pin-pad">
    <button class="pin-key" onclick="pinInput('1')">1</button>
    <button class="pin-key" onclick="pinInput('2')">2</button>
    <button class="pin-key" onclick="pinInput('3')">3</button>
    <button class="pin-key" onclick="pinInput('4')">4</button>
    <button class="pin-key" onclick="pinInput('5')">5</button>
    <button class="pin-key" onclick="pinInput('6')">6</button>
    <button class="pin-key" onclick="pinInput('7')">7</button>
    <button class="pin-key" onclick="pinInput('8')">8</button>
    <button class="pin-key" onclick="pinInput('9')">9</button>
    <button class="pin-key empty"></button>
    <button class="pin-key" onclick="pinInput('0')">0</button>
    <button class="pin-key backspace" onclick="pinBackspace()">‚å´</button>
  </div>
  <div class="lock-error" id="lockError"></div>
</div>

<div id="app-content" class="locked">

<!-- ===== TAB BAR ===== -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('create')">
    <span class="tab-icon">+</span>
    <span>–°–æ–∑–¥–∞—Ç—å</span>
  </button>
  <button class="tab" onclick="switchTab('licenses')">
    <span class="tab-icon">üîë</span>
    <span>–ö–ª—é—á–∏</span>
  </button>
  <button class="tab" onclick="switchTab('stats')">
    <span class="tab-icon">üìä</span>
    <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
  </button>
  <button class="tab" onclick="switchTab('tools')">
    <span class="tab-icon">‚öôÔ∏è</span>
    <span>–°–µ—Ä–≤–∏—Å</span>
  </button>
</div>

<!-- ===== PAGE: CREATE ===== -->
<div class="page active" id="page-create">
  <div class="page-title">–ù–æ–≤—ã–π –∫–ª—é—á</div>

  <div class="conn-status">
    <div class="conn-dot" id="connDot"></div>
    <span id="connText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
  </div>

  <div class="card">
    <div class="form-group">
      <label class="form-label">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</label>
      <select class="form-select" id="appSelect" onchange="onAppChange()">
        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</option>
        <option value="calculator">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</option>
        <option value="calendar">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</option>
        <option value="bundle">üéÅ –ö–æ–º–ø–ª–µ–∫—Ç (–æ–±–∞)</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">–¢–∞—Ä–∏—Ñ</label>
      <select class="form-select" id="planSelect" onchange="onPlanChange()">
        <option value="" disabled selected>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">–ò–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</label>
      <input type="text" class="form-input" id="buyerName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" autocomplete="off">
    </div>

    <div class="form-group">
      <label class="form-label">–°—É–º–º–∞ (‚ÇΩ)</label>
      <input type="number" class="form-input" id="paymentAmount" placeholder="0" inputmode="numeric">
    </div>

    <button class="btn btn-primary" id="generateBtn" onclick="generateKey()">–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á</button>
  </div>

  <div class="key-display" id="keyDisplay" style="display:none;"></div>
  <button class="btn btn-secondary" id="copyBtn" style="display:none;" onclick="copyKey()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
</div>

<!-- ===== PAGE: LICENSES ===== -->
<div class="page" id="page-licenses">
  <div class="page-title">–ö–ª—é—á–∏</div>

  <div class="search-bar">
    <input type="text" class="form-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, –∫–ª—é—á—É, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é..." oninput="filterLicenses()">
  </div>

  <div class="filter-row">
    <button class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">–í—Å–µ</button>
    <button class="filter-chip" data-filter="active" onclick="setFilter('active', this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
    <button class="filter-chip" data-filter="pending" onclick="setFilter('pending', this)">–û–∂–∏–¥–∞—é—Ç</button>
    <button class="filter-chip" data-filter="expired" onclick="setFilter('expired', this)">–ò—Å—Ç–µ–∫—à–∏–µ</button>
  </div>

  <div id="licensesList">
    <div style="text-align:center;padding:40px;color:var(--text2);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>

<!-- ===== PAGE: STATS ===== -->
<div class="page" id="page-stats">
  <div class="page-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="totalCount">-</div>
      <div class="stat-label">–í—Å–µ–≥–æ</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="activeCount">-</div>
      <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="pendingCount">-</div>
      <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalRevenue">-</div>
      <div class="stat-label">–î–æ—Ö–æ–¥</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">–ü–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º</div>
    <div id="appStats">
      <div style="text-align:center;padding:20px;color:var(--text2);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
</div>

<!-- ===== PAGE: TOOLS ===== -->
<div class="page" id="page-tools">
  <div class="page-title">–°–µ—Ä–≤–∏—Å</div>

  <div class="card">
    <div class="card-title">üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
    <button class="btn btn-secondary" style="margin-top:0;" onclick="exportDatabase()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã (JSON)</button>
    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç –±–∞–∑—ã</button>
    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImportFile(event)">
  </div>

  <div class="card">
    <div class="card-title">üîÑ –î–∞–Ω–Ω—ã–µ</div>
    <button class="btn btn-secondary" style="margin-top:0;" onclick="refreshLicenses()">–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
  </div>

  <div class="card">
    <div class="card-title">üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
    <button class="btn btn-secondary" style="margin-top:0;" onclick="changePin()">–°–º–µ–Ω–∏—Ç—å PIN-–∫–æ–¥</button>
    <button class="btn btn-secondary" onclick="resetPin()" style="color:var(--red);">–°–±—Ä–æ—Å–∏—Ç—å PIN-–∫–æ–¥</button>
  </div>
</div>

<!-- ===== EDIT MODAL ===== -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
    <div id="editModalContent"></div>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast"></div>

</div><!-- /app-content -->

<script>
// ============================================
// PIN LOCK
// ============================================
const PIN_STORAGE_KEY = 'illusionist_pin_hash';
const PIN_LOCK_KEY = 'illusionist_pin_lockout';
const PIN_SESSION_KEY = 'illusionist_pin_session';
const MAX_ATTEMPTS = 5;
const LOCKOUT_MS = 5 * 60 * 1000; // 5 minutes

let pinValue = '';
let pinAttempts = 0;
let pinMode = 'check'; // 'setup', 'confirm', 'check'
let pinSetupValue = '';

function hashPin(pin) {
  let hash = 0;
  const str = 'illusionist_salt_' + pin + '_key_gen';
  for (let i = 0; i < str.length; i++) {
    const chr = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + chr;
    hash |= 0;
  }
  return 'pin_' + Math.abs(hash).toString(36);
}

function initPinScreen() {
  const stored = localStorage.getItem(PIN_STORAGE_KEY);
  const session = sessionStorage.getItem(PIN_SESSION_KEY);

  // Already unlocked this session
  if (session === 'unlocked' && stored) {
    unlockApp();
    return;
  }

  if (!stored) {
    // First time ‚Äî setup PIN
    pinMode = 'setup';
    document.getElementById('lockTitle').textContent = '–°–æ–∑–¥–∞–π—Ç–µ PIN';
    document.getElementById('lockSubtitle').textContent = '–ü—Ä–∏–¥—É–º–∞–π—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π PIN-–∫–æ–¥ –¥–ª—è –∑–∞—â–∏—Ç—ã';
  } else {
    pinMode = 'check';
    // Check lockout
    const lockout = localStorage.getItem(PIN_LOCK_KEY);
    if (lockout) {
      const remaining = parseInt(lockout) - Date.now();
      if (remaining > 0) {
        showLockout(remaining);
        return;
      } else {
        localStorage.removeItem(PIN_LOCK_KEY);
      }
    }
  }
}

function pinInput(digit) {
  // Check lockout
  const lockout = localStorage.getItem(PIN_LOCK_KEY);
  if (lockout && parseInt(lockout) > Date.now()) return;

  if (pinValue.length >= 4) return;
  pinValue += digit;

  // Update dots
  const dots = document.querySelectorAll('#pinDots .pin-dot');
  dots.forEach((d, i) => {
    d.classList.toggle('filled', i < pinValue.length);
    d.classList.remove('error');
  });

  if (pinValue.length === 4) {
    setTimeout(() => handlePinComplete(), 200);
  }
}

function pinBackspace() {
  if (pinValue.length === 0) return;
  pinValue = pinValue.slice(0, -1);
  const dots = document.querySelectorAll('#pinDots .pin-dot');
  dots.forEach((d, i) => {
    d.classList.toggle('filled', i < pinValue.length);
    d.classList.remove('error');
  });
  document.getElementById('lockError').textContent = '';
}

function handlePinComplete() {
  if (pinMode === 'setup') {
    pinSetupValue = pinValue;
    pinMode = 'confirm';
    pinValue = '';
    document.getElementById('lockTitle').textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ PIN';
    document.getElementById('lockSubtitle').textContent = '–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥ –µ—â—ë —Ä–∞–∑ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
    resetDots();
  } else if (pinMode === 'confirm') {
    if (pinValue === pinSetupValue) {
      localStorage.setItem(PIN_STORAGE_KEY, hashPin(pinValue));
      sessionStorage.setItem(PIN_SESSION_KEY, 'unlocked');
      unlockApp();
    } else {
      showPinError('PIN –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–Ω–æ–≤–æ.');
      pinMode = 'setup';
      pinSetupValue = '';
      pinValue = '';
      resetDots();
      document.getElementById('lockTitle').textContent = '–°–æ–∑–¥–∞–π—Ç–µ PIN';
      document.getElementById('lockSubtitle').textContent = '–ü—Ä–∏–¥—É–º–∞–π—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π PIN-–∫–æ–¥';
    }
  } else {
    // Check mode
    const stored = localStorage.getItem(PIN_STORAGE_KEY);
    if (hashPin(pinValue) === stored) {
      sessionStorage.setItem(PIN_SESSION_KEY, 'unlocked');
      pinAttempts = 0;
      unlockApp();
    } else {
      pinAttempts++;
      const left = MAX_ATTEMPTS - pinAttempts;
      if (left <= 0) {
        const lockUntil = Date.now() + LOCKOUT_MS;
        localStorage.setItem(PIN_LOCK_KEY, lockUntil.toString());
        pinAttempts = 0;
        showLockout(LOCKOUT_MS);
      } else {
        showPinError(`–ù–µ–≤–µ—Ä–Ω—ã–π PIN. –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${left}`);
        pinValue = '';
        resetDotsError();
      }
    }
  }
}

function resetDots() {
  document.querySelectorAll('#pinDots .pin-dot').forEach(d => {
    d.classList.remove('filled', 'error');
  });
}

function resetDotsError() {
  const dots = document.querySelectorAll('#pinDots .pin-dot');
  dots.forEach(d => { d.classList.remove('filled'); d.classList.add('error'); });
  setTimeout(() => {
    dots.forEach(d => d.classList.remove('error'));
    pinValue = '';
  }, 500);
}

function showPinError(msg) {
  document.getElementById('lockError').textContent = msg;
}

function showLockout(msLeft) {
  const lockError = document.getElementById('lockError');
  document.querySelectorAll('.pin-key').forEach(k => k.style.opacity = '0.3');

  function updateLockout() {
    const lockUntil = parseInt(localStorage.getItem(PIN_LOCK_KEY) || '0');
    const remaining = lockUntil - Date.now();
    if (remaining <= 0) {
      localStorage.removeItem(PIN_LOCK_KEY);
      lockError.textContent = '';
      document.querySelectorAll('.pin-key').forEach(k => k.style.opacity = '1');
      return;
    }
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    lockError.textContent = `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${mins}:${secs < 10 ? '0' : ''}${secs}`;
    requestAnimationFrame(() => setTimeout(updateLockout, 1000));
  }
  updateLockout();
}

function unlockApp() {
  document.getElementById('lock-screen').classList.add('hidden');
  document.getElementById('app-content').classList.remove('locked');
  initFirebase();
}

function changePin() {
  const current = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π PIN-–∫–æ–¥:');
  if (!current) return;
  const storedHash = localStorage.getItem('gen_pin_hash');
  if (storedHash && hashPin(current) !== storedHash) {
    showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π PIN-–∫–æ–¥', 'error');
    return;
  }
  const newPin = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN-–∫–æ–¥ (4-8 —Ü–∏—Ñ—Ä):');
  if (!newPin || !/^\d{4,8}$/.test(newPin)) {
    showToast('PIN –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4-8 —Ü–∏—Ñ—Ä', 'error');
    return;
  }
  const confirmPin = prompt('–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π PIN-–∫–æ–¥:');
  if (newPin !== confirmPin) {
    showToast('PIN-–∫–æ–¥—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
    return;
  }
  localStorage.setItem('gen_pin_hash', hashPin(newPin));
  showToast('PIN-–∫–æ–¥ –∏–∑–º–µ–Ω—ë–Ω');
}

function resetPin() {
  const current = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π PIN-–∫–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞:');
  if (!current) return;
  const storedHash = localStorage.getItem('gen_pin_hash');
  if (storedHash && hashPin(current) !== storedHash) {
    showToast('–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥', 'error');
    return;
  }
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å PIN-–∫–æ–¥? –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.')) return;
  localStorage.removeItem('gen_pin_hash');
  sessionStorage.removeItem('gen_unlocked');
  showToast('PIN-–∫–æ–¥ —Å–±—Ä–æ—à–µ–Ω');
}

// ============================================
// CONFIG & STATE
// ============================================
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBEL4XCzjmHaqu4RbTqNzEKPi2Vfc4LXSI",
  authDomain: "calc76.firebaseapp.com",
  databaseURL: "https://calc76-default-rtdb.firebaseio.com",
  projectId: "calc76",
  storageBucket: "calc76.firebasestorage.app",
  messagingSenderId: "972929668805",
  appId: "1:972929668805:web:de4aa4097f03b97d39c2ac"
};

const PRODUCTS = {
  calculator: {
    name: 'üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä',
    plans: [
      { id: 'trial_7d', label: '7 –¥–Ω–µ–π (–ø—Ä–æ–±–Ω—ã–π)', price: 0, days: 7 },
      { id: '1m', label: '1 –º–µ—Å—è—Ü', price: 390, days: 30 },
      { id: '3m', label: '3 –º–µ—Å—è—Ü–∞', price: 990, days: 90 },
      { id: '6m', label: '6 –º–µ—Å—è—Ü–µ–≤', price: 1690, days: 180 },
      { id: '1y', label: '1 –≥–æ–¥', price: 2490, days: 365 },
      { id: '2y', label: '2 –≥–æ–¥–∞', price: 3990, days: 730 },
      { id: 'lifetime', label: '–ë–µ—Å—Å—Ä–æ—á–Ω–æ', price: 7990, days: 36500 }
    ]
  },
  calendar: {
    name: 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å',
    plans: [
      { id: 'trial_7d', label: '7 –¥–Ω–µ–π (–ø—Ä–æ–±–Ω—ã–π)', price: 0, days: 7 },
      { id: '1m', label: '1 –º–µ—Å—è—Ü', price: 390, days: 30 },
      { id: '3m', label: '3 –º–µ—Å—è—Ü–∞', price: 990, days: 90 },
      { id: '6m', label: '6 –º–µ—Å—è—Ü–µ–≤', price: 1690, days: 180 },
      { id: '1y', label: '1 –≥–æ–¥', price: 2490, days: 365 },
      { id: '2y', label: '2 –≥–æ–¥–∞', price: 3990, days: 730 },
      { id: 'early', label: '–†–∞–Ω–Ω–∏–π –¥–æ—Å—Ç—É–ø', price: 3990, days: 36500 },
      { id: 'lifetime', label: '–ë–µ—Å—Å—Ä–æ—á–Ω–æ', price: 6990, days: 36500 }
    ]
  },
  bundle: {
    name: 'üéÅ –ö–æ–º–ø–ª–µ–∫—Ç',
    plans: [
      { id: 'bundle_1m', label: '1 –º–µ—Å—è—Ü', price: 590, days: 30 },
      { id: 'bundle_3m', label: '3 –º–µ—Å—è—Ü–∞', price: 1490, days: 90 },
      { id: 'bundle_6m', label: '6 –º–µ—Å—è—Ü–µ–≤', price: 2490, days: 180 },
      { id: 'bundle_1y', label: '1 –≥–æ–¥', price: 3690, days: 365 },
      { id: 'bundle_2y', label: '2 –≥–æ–¥–∞', price: 5990, days: 730 },
      { id: 'bundle_lifetime', label: '–ë–µ—Å—Å—Ä–æ—á–Ω–æ', price: 9990, days: 36500 }
    ]
  }
};

let firebaseDB = null;
let firebaseEnabled = false;
let currentKey = '';
let allLicenses = [];
let currentFilter = 'all';
let _countdownInterval = null;

// ============================================
// TABS
// ============================================
function switchTab(tabId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + tabId).classList.add('active');
  event.currentTarget.classList.add('active');

  if (tabId === 'licenses' || tabId === 'stats') {
    renderAll();
  }
}

// ============================================
// TOAST
// ============================================
function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ============================================
// FIREBASE
// ============================================
async function initFirebase() {
  const dot = document.getElementById('connDot');
  const text = document.getElementById('connText');

  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    firebaseDB = firebase.database();
    await firebaseDB.ref('.info/connected').once('value');
    firebaseEnabled = true;
    dot.className = 'conn-dot ok';
    text.textContent = 'Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω';
    await refreshLicenses();
  } catch (err) {
    dot.className = 'conn-dot err';
    text.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
    document.getElementById('generateBtn').disabled = true;
  }
}

// ============================================
// APP/PLAN SELECTORS
// ============================================
function onAppChange() {
  const appId = document.getElementById('appSelect').value;
  const planSelect = document.getElementById('planSelect');
  const product = PRODUCTS[appId];

  planSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</option>';
  if (product) {
    product.plans.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.label} ‚Äî ${p.price === 0 ? '–±–µ—Å–ø–ª–∞—Ç–Ω–æ' : p.price + ' ‚ÇΩ'}`;
      opt.dataset.price = p.price;
      opt.dataset.days = p.days;
      planSelect.appendChild(opt);
    });
  }
  document.getElementById('paymentAmount').value = '';
}

function onPlanChange() {
  const planSelect = document.getElementById('planSelect');
  const selected = planSelect.selectedOptions[0];
  if (selected && selected.dataset.price !== undefined) {
    document.getElementById('paymentAmount').value = selected.dataset.price;
  }
}

// ============================================
// KEY GENERATION
// ============================================
function generateLicenseKey() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let key = '';
  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 4; j++) key += chars[Math.floor(Math.random() * chars.length)];
    if (i < 2) key += '-';
  }
  let sum = 0;
  const data = key.replace(/-/g, '');
  for (let i = 0; i < data.length; i++) sum += data.charCodeAt(i);
  return key + '-' + (sum % 10000).toString(36).toUpperCase().padStart(4, '0');
}

async function generateKey() {
  const appId = document.getElementById('appSelect').value;
  const planSelect = document.getElementById('planSelect');
  const selected = planSelect.selectedOptions[0];
  const name = document.getElementById('buyerName').value.trim();

  if (!appId) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'); return; }
  if (!selected || !selected.value) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ'); return; }
  if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è'); document.getElementById('buyerName').focus(); return; }
  if (!firebaseEnabled) { showToast('Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω'); return; }

  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

  try {
    // Generate unique key with duplicate check
    let attempts = 0;
    do {
      currentKey = generateLicenseKey();
      const existing = await firebaseDB.ref('licenses/' + currentKey.replace(/[\.#$\[\]]/g, '-')).once('value');
      if (!existing.val()) break;
      attempts++;
    } while (attempts < 5);
    if (attempts >= 5) { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞'); btn.disabled = false; btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á'; return; }

    const product = PRODUCTS[appId];
    const price = parseInt(document.getElementById('paymentAmount').value) || 0;
    const days = parseInt(selected.dataset.days) || 365;

    const licenseData = {
      key: currentKey,
      appName: product.name,
      buyer: { name, id: '', platform: 'manual' },
      payment: price,
      currency: 'RUB',
      expiryDays: days,
      planLabel: selected.textContent.split(' ‚Äî ')[0],
      created: new Date().toISOString(),
      activated: false,
      deviceId: null,
      installId: null,
      activatedDate: null,
      lastCheck: null,
      paymentMethod: 'manual',
      bundleId: null,
      orderNumber: null
    };

    await firebaseDB.ref('licenses/' + currentKey.replace(/[\.#$\[\]]/g, '-')).set(licenseData);

    document.getElementById('keyDisplay').textContent = currentKey;
    document.getElementById('keyDisplay').style.display = 'flex';
    document.getElementById('copyBtn').style.display = 'block';

    // Reset form
    document.getElementById('buyerName').value = '';
    btn.textContent = '‚úÖ –°–æ–∑–¥–∞–Ω!';
    btn.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
    setTimeout(() => {
      btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á';
      btn.style.background = '';
    }, 2000);

    await refreshLicenses();
  } catch (err) {
    showToast('–û—à–∏–±–∫–∞: ' + err.message);
    btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á';
  } finally {
    btn.disabled = false;
  }
}

function copyKey() {
  navigator.clipboard.writeText(currentKey).then(() => showToast('‚úÖ –ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'));
}

// ============================================
// LICENSES
// ============================================
async function refreshLicenses() {
  if (!firebaseEnabled) return;
  try {
    const snap = await firebaseDB.ref('licenses').once('value');
    allLicenses = Object.values(snap.val() || {});
    renderAll();
  } catch (err) {
    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
  }
}

function renderAll() {
  renderStats();
  renderLicensesList();
  renderAppStats();
}

function renderStats() {
  const active = allLicenses.filter(l => l.activated && !isExpired(l));
  const pending = allLicenses.filter(l => !l.activated);
  const revenue = allLicenses.reduce((s, l) => s + (parseInt(l.payment) || 0), 0);

  document.getElementById('totalCount').textContent = allLicenses.length;
  document.getElementById('activeCount').textContent = active.length;
  document.getElementById('pendingCount').textContent = pending.length;
  document.getElementById('totalRevenue').textContent = revenue.toLocaleString('ru-RU') + ' ‚ÇΩ';
}

function isExpired(lic) {
  if (!lic.activated || lic.expiryDays >= 36500) return false;
  let exp;
  if (lic.expiresAt) exp = new Date(lic.expiresAt);
  else if (lic.activatedDate) {
    exp = new Date(lic.activatedDate);
    exp.setDate(exp.getDate() + (lic.expiryDays || 365));
  } else return false;
  return new Date() > exp;
}

function getExpiresDate(lic) {
  if (lic.expiresAt) return new Date(lic.expiresAt);
  if (lic.activatedDate) {
    const d = new Date(lic.activatedDate);
    d.setDate(d.getDate() + (lic.expiryDays || 365));
    return d;
  }
  return null;
}

function setFilter(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderLicensesList();
}

function renderLicensesList() {
  if (_countdownInterval) { clearInterval(_countdownInterval); _countdownInterval = null; }

  const search = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
  let filtered = allLicenses.slice();

  if (search) {
    filtered = filtered.filter(l => {
      const name = (l.buyer?.name || '').toLowerCase();
      const key = (l.key || '').toLowerCase();
      const app = (l.appName || '').toLowerCase();
      const buyerId = (l.buyer?.id || '').toLowerCase();
      return name.includes(search) || key.includes(search) || app.includes(search) || buyerId.includes(search);
    });
  }

  if (currentFilter === 'active') filtered = filtered.filter(l => l.activated && !isExpired(l));
  else if (currentFilter === 'pending') filtered = filtered.filter(l => !l.activated);
  else if (currentFilter === 'expired') filtered = filtered.filter(l => isExpired(l));

  filtered.sort((a, b) => new Date(b.created) - new Date(a.created));

  const container = document.getElementById('licensesList');
  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text2);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    return;
  }

  const timers = [];
  container.innerHTML = filtered.map(lic => {
    const expired = isExpired(lic);
    const date = new Date(lic.created).toLocaleDateString('ru-RU');
    const price = parseInt(lic.payment) || 0;
    const isLifetime = lic.expiryDays >= 36500;

    let expiryInfo = '';
    if (isLifetime) {
      expiryInfo = '‚àû –ë–µ—Å—Å—Ä–æ—á–Ω–æ';
    } else if (lic.activated) {
      const exp = getExpiresDate(lic);
      if (exp) {
        if (expired) {
          expiryInfo = `‚õî –ò—Å—Ç—ë–∫ ${exp.toLocaleDateString('ru-RU')}`;
        } else {
          const daysLeft = Math.ceil((exp - new Date()) / 86400000);
          const timerId = 'cd_' + lic.key.replace(/[^A-Z0-9]/gi, '_');
          expiryInfo = `üìÖ ${exp.toLocaleDateString('ru-RU')} <span id="${timerId}" class="countdown"></span>`;
          timers.push({ id: timerId, expiresDate: exp });
        }
      }
    } else {
      const days = lic.expiryDays || 365;
      expiryInfo = days >= 36500 ? '‚àû –ë–µ—Å—Å—Ä–æ—á–Ω–æ' : `${days} –¥–Ω. (–Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω)`;
    }

    let statusBadge;
    if (expired) statusBadge = '<span class="badge badge-expired">–ò—Å—Ç—ë–∫</span>';
    else if (lic.activated) statusBadge = '<span class="badge badge-active">–ê–∫—Ç–∏–≤–µ–Ω</span>';
    else statusBadge = '<span class="badge badge-pending">–û–∂–∏–¥–∞–µ—Ç</span>';

    const safeKey = lic.key.replace(/'/g, "\\'");

    return `
      <div class="license-card ${expired ? 'expired' : ''}">
        <div class="license-header">
          <div>
            <div class="license-app">${lic.appName || '‚Äî'}</div>
            <div class="license-buyer">${lic.buyer?.name || '‚Äî'}</div>
          </div>
          ${statusBadge}
        </div>
        <div class="license-key">
          <span>${lic.key}</span>
          <button class="btn-small btn-secondary" onclick="navigator.clipboard.writeText('${safeKey}');showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')" style="margin:0;padding:4px 8px;font-size:11px;">üìã</button>
        </div>
        <div class="license-meta">
          <span>${date}</span>
          <span>${price > 0 ? price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–±–µ—Å–ø–ª–∞—Ç–Ω–æ'}</span>
          <span>${expiryInfo}</span>
        </div>
        <div class="license-actions">
          <button class="btn-small btn-secondary" onclick="openEditModal('${safeKey}')">‚úèÔ∏è</button>
          ${lic.activated ? `<button class="btn-small btn-secondary" onclick="unlinkDevice('${safeKey}')">üì±‚úï</button>` : ''}
          <button class="btn-small btn-danger" onclick="deleteLicense('${safeKey}')">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join('');

  // Timers
  if (timers.length > 0) {
    function tick() {
      const now = new Date();
      timers.forEach(({ id, expiresDate }) => {
        const el = document.getElementById(id);
        if (!el) return;
        const ms = expiresDate - now;
        if (ms <= 0) { clearInterval(_countdownInterval); refreshLicenses(); return; }
        const d = Math.floor(ms / 86400000);
        const h = Math.floor((ms % 86400000) / 3600000);
        const m = Math.floor((ms % 3600000) / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        const hh = (h < 10 ? '0' : '') + h;
        const mm = (m < 10 ? '0' : '') + m;
        const ss = (s < 10 ? '0' : '') + s;
        el.textContent = d > 0 ? `${d}–¥ ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
        const hours = ms / 3600000;
        el.style.color = hours < 1 ? '#ef4444' : hours < 24 ? '#f97316' : hours < 72 ? '#eab308' : '#22c55e';
      });
    }
    tick();
    _countdownInterval = setInterval(tick, 1000);
  }
}

function renderAppStats() {
  const data = {};
  allLicenses.forEach(l => {
    const app = l.appName || '‚Äî';
    if (!data[app]) data[app] = { count: 0, revenue: 0, activated: 0 };
    data[app].count++;
    data[app].revenue += parseInt(l.payment) || 0;
    if (l.activated) data[app].activated++;
  });

  const el = document.getElementById('appStats');
  const entries = Object.entries(data).sort((a, b) => b[1].revenue - a[1].revenue);
  if (entries.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text2);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    return;
  }

  el.innerHTML = entries.map(([app, s]) => `
    <div class="app-stat-card">
      <div class="app-stat-header">
        <span class="app-stat-name">${app}</span>
        <span class="app-stat-revenue">${s.revenue.toLocaleString('ru-RU')} ‚ÇΩ</span>
      </div>
      <div class="app-stat-details">
        <span>–ü—Ä–æ–¥–∞–Ω–æ: <b style="color:#fff">${s.count}</b></span>
        <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö: <b style="color:var(--green)">${s.activated}</b></span>
      </div>
    </div>
  `).join('');
}

// ============================================
// EDIT MODAL
// ============================================
function openEditModal(key) {
  const lic = allLicenses.find(l => l.key === key);
  if (!lic) return;

  const modal = document.getElementById('editModal');
  const content = document.getElementById('editModalContent');

  const hasExpiry = lic.expiryDays && lic.expiryDays < 36500;
  const currentExpiry = lic.expiresAt ? new Date(lic.expiresAt).toISOString().split('T')[0] : '';

  content.innerHTML = `
    <div class="form-group">
      <label class="form-label">–ò–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</label>
      <input type="text" class="form-input" id="editName" value="${lic.buyer?.name || ''}">
    </div>
    <div class="form-group">
      <label class="form-label">VK ID –ø–æ–∫—É–ø–∞—Ç–µ–ª—è <span style="color:var(--text2);font-size:11px;">(–Ω–∞–ø—Ä–∏–º–µ—Ä: vk_196783025)</span></label>
      <input type="text" class="form-input" id="editVkId" value="${lic.buyer?.id || ''}" placeholder="vk_XXXXXXXXX">
    </div>
    <div class="form-group">
      <label class="form-label">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</label>
      <input type="text" class="form-input" id="editApp" value="${lic.appName || ''}">
    </div>
    ${hasExpiry ? `
    <div class="form-group">
      <label class="form-label">–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è (${currentExpiry ? '—Ç–µ–∫—É—â–∞—è: ' + new Date(lic.expiresAt).toLocaleDateString('ru-RU') : '–Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'})</label>
      <input type="date" class="form-input" id="editExpiry" value="${currentExpiry}">
    </div>` : ''}
    <button class="btn btn-primary" onclick="saveEdit('${key.replace(/'/g, "\\'")}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
  `;

  modal.classList.add('show');
  modal.onclick = e => { if (e.target === modal) closeEditModal(); };
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('show');
}

async function saveEdit(key) {
  try {
    const keyRef = firebaseDB.ref('licenses/' + key.replace(/[\.#$\[\]]/g, '-'));
    const vkIdVal = document.getElementById('editVkId').value.trim();
    const update = {
      'buyer/name': document.getElementById('editName').value.trim(),
      'buyer/id': vkIdVal || null,
      'appName': document.getElementById('editApp').value.trim()
    };
    const expiryInput = document.getElementById('editExpiry');
    if (expiryInput && expiryInput.value) {
      update.expiresAt = new Date(expiryInput.value).toISOString();
    }
    await keyRef.update(update);
    closeEditModal();
    showToast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    await refreshLicenses();
  } catch (err) {
    showToast('–û—à–∏–±–∫–∞: ' + err.message);
  }
}

// ============================================
// ACTIONS
// ============================================
async function unlinkDevice(key) {
  if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç —ç—Ç–æ–≥–æ –∫–ª—é—á–∞?')) return;
  try {
    const keyRef = firebaseDB.ref('licenses/' + key.replace(/[\.#$\[\]]/g, '-'));
    await keyRef.update({ activated: false, deviceId: null, installId: null, activatedDate: null, lastCheck: null });
    showToast('‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–≤—è–∑–∞–Ω–æ');
    await refreshLicenses();
  } catch (err) { showToast('–û—à–∏–±–∫–∞: ' + err.message); }
}

async function deleteLicense(key) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á ' + key + '?')) return;
  try {
    await firebaseDB.ref('licenses/' + key.replace(/[\.#$\[\]]/g, '-')).remove();
    showToast('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
    await refreshLicenses();
  } catch (err) { showToast('–û—à–∏–±–∫–∞: ' + err.message); }
}

// ============================================
// EXPORT / IMPORT
// ============================================
async function exportDatabase() {
  if (!firebaseEnabled) { showToast('Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω'); return; }
  try {
    const snap = await firebaseDB.ref('licenses').once('value');
    const licenses = snap.val() || {};
    if (!Object.keys(licenses).length) { showToast('–ë–∞–∑–∞ –ø—É—Å—Ç–∞'); return; }
    const data = { version: '2.0', exported: new Date().toISOString(), totalLicenses: Object.keys(licenses).length, licenses };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
  } catch (err) { showToast('–û—à–∏–±–∫–∞: ' + err.message); }
}

async function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (!confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—é—á–∏ —Å —Ç–∞–∫–∏–º–∏ –∂–µ ID –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.')) {
    event.target.value = '';
    return;
  }
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    const licenses = data.licenses || data;
    if (typeof licenses !== 'object') throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
    await firebaseDB.ref('licenses').update(licenses);
    showToast(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${Object.keys(licenses).length} –∫–ª—é—á–µ–π`);
    await refreshLicenses();
  } catch (err) {
    showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message);
  }
  event.target.value = '';
}

function filterLicenses() {
  renderLicensesList();
}

// ============================================
// INIT
// ============================================
window.addEventListener('load', initPinScreen);
</script>
</body>
</html>